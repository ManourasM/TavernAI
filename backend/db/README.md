# TavernAI Database Migrations

This directory contains database migration scripts managed by [Alembic](https://alembic.sqlalchemy.org/), a lightweight database migration tool for SQLAlchemy.

## Overview

- **Canonical Models**: [`app/db/models.py`](../app/db/models.py) defines the authoritative SQLAlchemy ORM models
- **Alembic Configuration**: [`alembic.ini`](../alembic.ini) and [`alembic/env.py`](../alembic/env.py) configure migration behavior
- **Revision History**: [`alembic/versions/`](../alembic/versions/) contains migration files

## Setup

### Prerequisites

Ensure the following dependencies are installed:

```bash
pip install -r requirements.txt
```

Key packages:
- `sqlalchemy` (already present)
- `alembic` (added in requirements.txt)
- `psycopg2-binary` (for PostgreSQL support; optional)

### Database URL Configuration

Alembic reads the database URL from the `APP_DATABASE_URL` environment variable:

```bash
# PostgreSQL (production)
export APP_DATABASE_URL="postgresql://user:password@localhost/tavern_db"

# SQLite (development/testing)
export APP_DATABASE_URL="sqlite:///./tavern.db"
```

If `APP_DATABASE_URL` is not set, Alembic defaults to a local SQLite database (`sqlite:///./tavern.db`).

## Common Tasks

### 1. Display Current Schema Revision

Check which migration revision is currently applied:

```bash
cd backend
alembic current
```

### 2. Create a New Migration (Autogenerate)

After modifying models in `app/db/models.py`, generate a new migration:

```bash
cd backend
alembic revision --autogenerate -m "add_column_to_users"
```

This creates a new file in `alembic/versions/` with auto-detected changes.

**Important**: Always review the generated migration before applying it. Autogenerate is not perfect and may miss some changes.

### 3. Create a Manual Migration

For complex or custom migrations:

```bash
cd backend
alembic revision -m "custom_migration_name"
```

Edit the generated file to add your custom SQL or ORM operations.

### 4. Apply Migrations (Upgrade)

Apply pending migrations to the database:

```bash
cd backend
alembic upgrade head
```

Apply to a specific revision:

```bash
alembic upgrade abc123def
```

### 5. Rollback Migrations (Downgrade)

Revert to a previous schema state:

```bash
cd backend
alembic downgrade -1  # Revert one migration
alembic downgrade abc123def  # Revert to specific revision
```

### 6. View Migration History

List all migrations and their status:

```bash
cd backend
alembic history
```

View current vs. head revision:

```bash
alembic current
alembic heads
```

## Models Reference

The canonical models are defined in [`app/db/models.py`](../app/db/models.py):

- **User**: System users (staff, waiters, admin) with roles and PINs
- **MenuVersion**: Versioned menu snapshots with full JSON blob
- **MenuItem**: Items in a menu version linked to categories and stations
- **TableSession**: Restaurant table session (open/close lifecycle)
- **Order**: Orders for a table with status tracking
- **OrderItem**: Individual items within an order
- **Receipt**: Receipt/invoice records for orders
- **NLPTrainingSample**: Training data for NLP classification

All relationships use lazy="select" by default. Foreign keys cascade deletes appropriately.

## Workflow

### For Development

1. **Modify models** in `app/db/models.py`
2. **Generate migration**: `alembic revision --autogenerate -m "description"`
3. **Review the generated file** in `alembic/versions/`
4. **Test**: `alembic upgrade head` or `alembic downgrade -1`
5. **Commit** both the model changes and migration file

### For Production Deployment

1. **Pull latest code** including migrations
2. **Verify**: `alembic current`
3. **Apply migrations**: `alembic upgrade head`
4. **Verify**: `alembic current` confirms head revision is applied
5. **Test application** to ensure compatibility

## Troubleshooting

### "sqlalchemy.exc.OperationalError: database is locked"

SQLite can be sensitive to concurrent access. Use PostgreSQL for production or increase lock timeouts.

### "No such table: alembic_version"

The migration history table doesn't exist. Make sure at least one migration has been applied:

```bash
alembic upgrade head
```

### "Target database is not up to date"

Your local database is ahead of the code. Downgrade or reset:

```bash
alembic stamp head  # Mark current state as head (use with caution)
```

### "Can't locate revision identified by '...'"

The revision doesn't exist. Check revision history:

```bash
alembic history
```

## Best Practices

1. **Always review autogenerated migrations** before applying.
2. **Name migrations clearly**: `alembic revision --autogenerate -m "add_user_roles_column"`
3. **Keep migrations focused**: One logical change per migration file.
4. **Test rollbacks**: Verify downgrade paths work: `alembic downgrade -1 && alembic upgrade +1`
5. **Use environment variables** for database URLs in CI/CD pipelines.
6. **Commit migrations to version control** alongside code changes.
7. **Don't modify production data** in migration scripts; use separate data scripts.

## References

- [Alembic Official Documentation](https://alembic.sqlalchemy.org/)
- [SQLAlchemy ORM Overview](https://docs.sqlalchemy.org/en/20/orm/)
- [PostgreSQL with Alembic](https://alembic.sqlalchemy.org/en/latest/cookbook.html)

## Implementation Summary

```bash
python ALEMBIC_IMPLEMENTATION.py
```