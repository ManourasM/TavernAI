# 2.3 User and Workstation Handling

This document summarizes user and workstation management features implemented in TavernAI, with main file paths, implementation strategies, and key decisions.

## 1) User management and access control

**What it does**
- Allows admins to create, edit, and manage user accounts
- Controls which workstations (kitchen, grill, drinks, etc.) each user can access
- Supports role-based access (admin, waiter, station operator)
- Display user creation timestamps in local time

**Key files**
- backend/app/api/users_router.py (user CRUD operations)
- backend/app/db/models.py (User model with workstation relationships)
- backend/app/db/dependencies.py (JWT token generation and validation)
- mobile-app/src/pages/Admin/Users.jsx (user management UI)
- mobile-app/src/services/api.js (user API client)

**Strategy and decisions**
- Users have many-to-many relationships with workstations through a junction table
- JWT tokens encode user ID and roles for simple, stateless authentication
- Admin panel allows assigning/removing workstation access per user
- User creation timestamps are stored as naive datetime in Athens timezone
- Frontend displays user timestamps in local Greek format (Europe/Athens) with fallback


## 2) Workstation handling and dynamic categories

**What it does**
- Allows admins to dynamically create and manage workstations (stations)
- Replaces hardcoded kitchen/grill/drinks categories with user-defined workstations
- Workstations determine menu item categories and NLP classification routing
- Each workstation can be activated/deactivated and assigned display colors
- Workstation metadata is available to the NLP classifier for accurate item routing

**Key files**
- backend/app/api/workstations_router.py (workstation CRUD operations)
- backend/app/db/models.py (Workstation model)
- mobile-app/src/services/workstationsService.js (workstation API client)
- mobile-app/src/pages/Admin/Workstations.jsx (workstation management UI)
- mobile-app/src/pages/Admin/MenuEditor.jsx (dynamic category selection)
- mobile-app/src/components/ItemEditorModal.jsx (category dropdown in item editor)
- mobile-app/src/store/menuStore.js (workstation list integration)
- backend/app/nlp.py (dynamic category matching)

**Strategy and decisions**
- Workstations are stored in the database with slug identifiers (kitchen, grill, drinks, etc.)
- Each workstation has an active flag, display name, color, and description
- Menu item categories are computed dynamically from active workstations at runtime
- ItemEditorModal receives `categoryOptions` prop from parent component to enable dynamic dropdowns
- API metadata endpoint (`/config`) returns `available_categories` list for frontend validation
- Frontend filters out metadata before saving menu to prevent validation errors
- NLP classification uses workstation slugs to route items to correct station
- Workstation timestamps (created_at) are stored in Athens timezone


## 3) Timestamp localization to local time

**What it does**
- Converts all application timestamps from UTC to local Greek time (Europe/Athens timezone)
- Ensures consistent timestamp display across backend storage, API responses, and frontend UI
- Provides Windows compatibility fallback when tzdata package is unavailable
- All order times, receipt timestamps, and user activity logs display in user's local timezone

**Key files**
- backend/app/utils/time_utils.py (centralized timezone utilities with fallback)
- backend/app/db/models.py (datetime defaults use now_athens_naive)
- backend/app/storage/models.py (OrderModel serialization with Athens timezone)
- backend/app/storage/sqlite.py, inmemory.py, sqlalchemy_adapter.py (storage layer timezone handling)
- backend/app/api/nlp_router.py (NLP sample timestamps)
- backend/app/api/receipts_router.py (receipt and table session timestamps)
- backend/app/db/order_utils.py (order item creation timestamps)
- backend/app/db/dependencies.py (JWT token expiry in Athens time)
- mobile-app/src/services/menuService.js (frontend date formatting)
- mobile-app/src/pages/Admin/Users.jsx (user list timestamp display)
- mobile-app/src/pages/Admin/Workstations.jsx (workstation creation timestamp display)
- mobile-app/src/pages/Admin/NLPReview.jsx (NLP rule creation timestamp display)
- mobile-app/src/components/StationView.jsx (order time display in station UIs)
- mobile-app/src/store/notificationStore.js (notification timestamp storage)

**Strategy and decisions**
- Centralized `time_utils.py` module provides timezone helpers to avoid duplicate logic
- All datetime creation in backend uses one of: `now_athens()`, `now_athens_naive()`, or `iso_athens()`
- Naive datetimes (`now_athens_naive`) are stored in database; ISO strings with offset are sent via API
- Conversion function `to_athens()` standardizes datetime handling during serialization
- Frontend uses JavaScript `toLocaleString()` and `toLocaleDateString()` with Greek locale and Europe/Athens timezone
- Fallback mechanism in `time_utils.py`: if `ZoneInfo("Europe/Athens")` is unavailable (Windows without tzdata), uses system local timezone
- No hardcoded UTC timestamps remain in production code
- Test data uses `now_athens_naive()` for consistency with production models

### Timezone Implementation Pattern

**Backend Creation Pattern:**
```python
from app.utils.time_utils import now_athens_naive, iso_athens, to_athens

# Store as naive datetime
created_at = now_athens_naive()  # datetime object in Athens timezone (naive)

# Return as ISO string with offset
created_at_str = to_athens(created_at).isoformat()  # "2026-02-25T14:30:00+02:00"
```

**Frontend Display Pattern:**
```javascript
// Convert ISO string to local Greek time display
const timeString = new Date(item.created_at).toLocaleTimeString('el-GR', { 
    timeZone: 'Europe/Athens' 
});

// Full datetime display
const dateString = new Date(dateStr).toLocaleString('el-GR', { 
    year: 'numeric', 
    month: 'short', 
    day: 'numeric', 
    hour: '2-digit', 
    minute: '2-digit', 
    timeZone: 'Europe/Athens' 
});
```

**Windows Compatibility:**
- Application includes fallback mechanism for systems without `tzdata` package
- If exact Europe/Athens ZoneInfo cannot be loaded, uses system local timezone
- Maintains functionality without requiring additional dependencies on Windows
- Users can optionally install `pip install tzdata` for exact Europe/Athens DST rules
