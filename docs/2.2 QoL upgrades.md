# 2.2 QoL upgrades

This document summarizes quality-of-life upgrades implemented in TavernAI, with main file paths, implementation strategies, and key decisions.

## 1) Order history

**What it does**
- Provides an order history view with optional date filtering.

**Key files**
- backend/app/api/receipts_router.py
- mobile-app/src/pages/OrdersHistory.jsx
- mobile-app/src/services/api.js

**Strategy and decisions**
- Backend accepts date range filters using query parameter aliases to match the frontend.
- The history endpoint returns data suitable for a table/list view in the PWA.


## 2) Receipt print

**What it does**
- Generates and opens a printable receipt view on table finalization.

**Key files**
- backend/app/main.py (table finalization flow and receipt message)
- mobile-app/src/pages/ReceiptView.jsx
- mobile-app/src/components/WaiterView.jsx

**Strategy and decisions**
- When a table is finalized, a receipt view is opened in a new tab with a guard to prevent duplicates.
- The waiter UI uses a global map to avoid opening the same receipt more than once.


## 3) Order confirmation screen

**What it does**
- Adds a confirmation modal showing classified items before sending to stations.
- Allows inline corrections ("Wrong?") before submit.

**Key files**
- backend/app/main.py (POST /order/preview)
- backend/app/nlp.py (classification used by preview)
- mobile-app/src/components/WaiterView.jsx
- mobile-app/src/components/WaiterView.css
- mobile-app/src/services/api.js

**Strategy and decisions**
- A preview endpoint returns classification results without storing or broadcasting.
- The waiter flow switches from direct submit to preview + confirm.
- Corrections in preview reclassify immediately and update the preview list.


## 4) NLP rule setting and corrections

**What it does**
- Captures corrections as rules and reuses them for future classification.
- Supports admin rule review, edit, and delete.

**Key files**
- backend/app/api/nlp_router.py (capture, rules list/update/delete)
- backend/app/db/models.py (NLPTrainingSample)
- backend/app/main.py (apply override rules during classification)
- backend/app/nlp.py (rule normalization and override matching)
- mobile-app/src/components/CorrectionModal.jsx
- mobile-app/src/components/CorrectionModal.css
- mobile-app/src/pages/Admin/NLPReview.jsx
- mobile-app/src/pages/Admin/NLPReview.css
- mobile-app/src/services/api.js

**Strategy and decisions**
- Rules are based on normalized free-text with quantity and units stripped.
- Rules are stored as corrected menu item IDs (string IDs matching menu.json entries).
- Override rules are applied before default menu matching.


## 5) Menu editing and versioning

**What it does**
- Supports menu editing, hidden item toggles, and menu versions.

**Key files**
- backend/app/api/menu_router.py
- backend/app/db/models.py (MenuVersion, MenuItem)
- backend/app/db/menu_access.py
- mobile-app/src/pages/Admin/MenuEditor.jsx
- mobile-app/src/pages/Admin/MenuEditor.css
- mobile-app/src/store/menuStore.js

**Strategy and decisions**
- Menu versions are stored in the database, with a JSON snapshot per version.
- Hidden items are excluded from active matching but still visible in admin tools.
- The frontend loads menu data from the backend with a fallback to local menu.json.


## 6) Hidden items and unclassified protection

**What it does**
- Prevents orders that contain hidden items or items that cannot be matched.

**Key files**
- backend/app/main.py (hidden item and unclassified checks)
- backend/app/nlp.py (normalization utilities)
- mobile-app/src/components/WaiterView.jsx

**Strategy and decisions**
- Hidden item detection uses normalized token matching against the full menu.
- Unclassified items are blocked and surfaced to the waiter with a modal.


## 7) Data persistence improvements

**What it does**
- Prevents database tables from being dropped on restart.

**Key files**
- backend/app/db/__init__.py

**Strategy and decisions**
- Startup now only creates missing tables; it does not drop existing ones.

